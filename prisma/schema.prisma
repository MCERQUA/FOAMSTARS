// FOAMSTARS Database Schema
// Neon PostgreSQL + Clerk Auth

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER PROFILES (linked to Clerk)
// ============================================
model Profile {
  id                  String    @id @default(uuid())
  clerkId             String    @unique @map("clerk_id")
  email               String    @unique
  fullName            String?   @map("full_name")
  phone               String?
  avatarUrl           String?   @map("avatar_url")
  bio                 String?
  userType            String    @default("customer") @map("user_type") // contractor | customer

  // Business info (for contractors)
  businessName        String?   @map("business_name")
  businessLicense     String?   @map("business_license")
  yearsExperience     Int?      @map("years_experience")
  hourlyRate          Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  minProjectBudget    Decimal?  @map("min_project_budget") @db.Decimal(10, 2)
  serviceAreaRadius   Int?      @map("service_area_radius")

  // Location
  address             String?
  city                String?
  state               String?
  zipCode             String?   @map("zip_code")
  country             String?   @default("USA")

  // Social links
  websiteUrl          String?   @map("website_url")
  facebookUrl         String?   @map("facebook_url")
  instagramUrl        String?   @map("instagram_url")
  linkedinUrl         String?   @map("linkedin_url")

  // Settings
  emailNotifications  Boolean   @default(true) @map("email_notifications")
  smsNotifications    Boolean   @default(false) @map("sms_notifications")
  profileCompletion   Int       @default(0) @map("profile_completion")
  isVerified          Boolean   @default(false) @map("is_verified")
  lastActive          DateTime? @map("last_active")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  listings            BusinessListing[]
  reviewsWritten      Review[]          @relation("ReviewAuthor")
  reviewVotes         ReviewVote[]
  bookingsAsCustomer  Booking[]         @relation("CustomerBookings")
  bookingsAsContractor Booking[]        @relation("ContractorBookings")
  bookingMessages     BookingMessage[]
  statusChanges       BookingStatusHistory[]

  @@map("profiles")
}

// ============================================
// SERVICE CATEGORIES
// ============================================
model Category {
  id              String    @id @default(uuid())
  name            String    @unique
  slug            String    @unique
  description     String?
  icon            String?
  imageUrl        String?   @map("image_url")
  color           String?
  displayOrder    Int       @default(0) @map("display_order")
  isActive        Boolean   @default(true) @map("is_active")
  isFeatured      Boolean   @default(false) @map("is_featured")
  metaTitle       String?   @map("meta_title")
  metaDescription String?   @map("meta_description")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  listings        BusinessListing[]

  @@map("categories")
}

// ============================================
// BUSINESS LISTINGS (Contractors/Companies)
// ============================================
model BusinessListing {
  id                    String    @id @default(uuid())
  ownerId               String    @map("owner_id")
  categoryId            String    @map("category_id")

  // Basic info
  title                 String
  slug                  String    @unique
  businessName          String?   @map("business_name")
  description           String?
  subcategory           String?
  tags                  String[]

  // Contact
  email                 String?
  phone                 String?
  websiteUrl            String?   @map("website_url")

  // Location
  address               String?
  city                  String?
  state                 String?
  zipCode               String?   @map("zip_code")
  country               String?   @default("USA")
  latitude              Decimal?  @db.Decimal(10, 8)
  longitude             Decimal?  @db.Decimal(11, 8)

  // Media
  featuredImageUrl      String?   @map("featured_image_url")
  galleryImages         String[]  @map("gallery_images")
  videoUrl              String?   @map("video_url")

  // Business details
  yearsInBusiness       Int?      @map("years_in_business")
  employeesCount        Int?      @map("employees_count")
  certifications        String[]
  businessLicense       String?   @map("business_license")
  insuranceInfo         String?   @map("insurance_info")

  // Pricing
  pricingModel          String?   @map("pricing_model") // hourly | fixed | quote
  hourlyRate            Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  minProjectBudget      Decimal?  @map("min_project_budget") @db.Decimal(10, 2)
  maxProjectBudget      Decimal?  @map("max_project_budget") @db.Decimal(10, 2)
  depositRequired       Boolean   @default(false) @map("deposit_required")
  depositPercentage     Int?      @map("deposit_percentage")

  // Availability
  isAvailable           Boolean   @default(true) @map("is_available")
  emergencyServices     Boolean   @default(false) @map("emergency_services")
  acceptsOnlineBooking  Boolean   @default(false) @map("accepts_online_booking")
  acceptsOnlinePayments Boolean   @default(false) @map("accepts_online_payments")
  availabilitySchedule  Json?     @map("availability_schedule")
  serviceAreaRadius     Int?      @map("service_area_radius")

  // Stats & ratings
  averageRating         Decimal   @default(0) @map("average_rating") @db.Decimal(3, 2)
  reviewCount           Int       @default(0) @map("review_count")
  viewCount             Int       @default(0) @map("view_count")
  contactCount          Int       @default(0) @map("contact_count")
  responseRate          Int?      @map("response_rate")
  responseTimeHours     Int?      @map("response_time_hours")

  // Status & visibility
  status                String    @default("pending") // pending | active | inactive | suspended
  isVerified            Boolean   @default(false) @map("is_verified")
  isFeatured            Boolean   @default(false) @map("is_featured")
  featuredUntil         DateTime? @map("featured_until")

  // SEO
  metaTitle             String?   @map("meta_title")
  metaDescription       String?   @map("meta_description")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  owner                 Profile   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  category              Category  @relation(fields: [categoryId], references: [id])
  reviews               Review[]
  bookings              Booking[]

  @@index([ownerId])
  @@index([categoryId])
  @@index([status])
  @@index([city, state])
  @@map("business_listings")
}

// ============================================
// REVIEWS
// ============================================
model Review {
  id                  String    @id @default(uuid())
  listingId           String    @map("listing_id")
  reviewerId          String    @map("reviewer_id")
  bookingId           String?   @map("booking_id")

  // Content
  title               String?
  content             String
  rating              Int       // 1-5
  images              String[]

  // Sub-ratings
  qualityRating       Int?      @map("quality_rating")
  communicationRating Int?      @map("communication_rating")
  timelinessRating    Int?      @map("timeliness_rating")
  valueRating         Int?      @map("value_rating")

  // Owner response
  ownerResponse       String?   @map("owner_response")
  ownerResponseDate   DateTime? @map("owner_response_date")

  // Stats & status
  helpfulVotes        Int       @default(0) @map("helpful_votes")
  reportedCount       Int       @default(0) @map("reported_count")
  status              String    @default("published") // published | pending | hidden
  isVerified          Boolean   @default(false) @map("is_verified")
  isFeatured          Boolean   @default(false) @map("is_featured")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  listing             BusinessListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reviewer            Profile         @relation("ReviewAuthor", fields: [reviewerId], references: [id])
  votes               ReviewVote[]

  @@index([listingId])
  @@index([reviewerId])
  @@map("reviews")
}

// ============================================
// REVIEW VOTES
// ============================================
model ReviewVote {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  voterId   String   @map("voter_id")
  isHelpful Boolean  @map("is_helpful")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  voter     Profile  @relation(fields: [voterId], references: [id])

  @@unique([reviewId, voterId])
  @@map("review_votes")
}

// ============================================
// BOOKINGS
// ============================================
model Booking {
  id                    String    @id @default(uuid())
  bookingReference      String    @unique @map("booking_reference")
  listingId             String    @map("listing_id")
  customerId            String    @map("customer_id")
  contractorId          String    @map("contractor_id")

  // Basic info
  title                 String
  description           String?
  projectType           String?   @map("project_type")

  // Schedule
  scheduledDate         DateTime  @map("scheduled_date")
  scheduledStartTime    String?   @map("scheduled_start_time")
  scheduledEndTime      String?   @map("scheduled_end_time")
  estimatedDurationHours Int?     @map("estimated_duration_hours")

  // Location
  serviceAddress        String    @map("service_address")
  serviceCity           String    @map("service_city")
  serviceState          String    @map("service_state")
  serviceZipCode        String?   @map("service_zip_code")
  accessInstructions    String?   @map("access_instructions")

  // Pricing
  estimatedCost         Decimal?  @map("estimated_cost") @db.Decimal(10, 2)
  quotedPrice           Decimal?  @map("quoted_price") @db.Decimal(10, 2)
  finalPrice            Decimal?  @map("final_price") @db.Decimal(10, 2)
  depositAmount         Decimal?  @map("deposit_amount") @db.Decimal(10, 2)
  depositPaid           Boolean   @default(false) @map("deposit_paid")
  paymentMethod         String?   @map("payment_method")
  refundAmount          Decimal?  @map("refund_amount") @db.Decimal(10, 2)

  // Status
  status                String    @default("pending") // pending | confirmed | in_progress | completed | cancelled
  urgencyLevel          String?   @map("urgency_level") // normal | urgent | emergency

  // Notes
  customerNotes         String?   @map("customer_notes")
  contractorNotes       String?   @map("contractor_notes")
  adminNotes            String?   @map("admin_notes")
  specialRequirements   String?   @map("special_requirements")

  // Work details
  materialsNeeded       String[]  @map("materials_needed")
  toolsNeeded           String[]  @map("tools_needed")
  workPhotos            String[]  @map("work_photos")
  completionNotes       String?   @map("completion_notes")
  workCompletedAt       DateTime? @map("work_completed_at")

  // Warranty
  warrantyPeriodMonths  Int?      @map("warranty_period_months")
  warrantyExpiresAt     DateTime? @map("warranty_expires_at")

  // Cancellation
  cancelledAt           DateTime? @map("cancelled_at")
  cancelledBy           String?   @map("cancelled_by")
  cancellationReason    String?   @map("cancellation_reason")

  // Reviews
  reviewRequested       Boolean   @default(false) @map("review_requested")
  reviewSubmitted       Boolean   @default(false) @map("review_submitted")

  // Tracking
  source                String?   // website | referral | google | etc

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  listing               BusinessListing @relation(fields: [listingId], references: [id])
  customer              Profile         @relation("CustomerBookings", fields: [customerId], references: [id])
  contractor            Profile         @relation("ContractorBookings", fields: [contractorId], references: [id])
  messages              BookingMessage[]
  statusHistory         BookingStatusHistory[]

  @@index([customerId])
  @@index([contractorId])
  @@index([listingId])
  @@index([status])
  @@map("bookings")
}

// ============================================
// BOOKING MESSAGES
// ============================================
model BookingMessage {
  id            String    @id @default(uuid())
  bookingId     String    @map("booking_id")
  senderId      String    @map("sender_id")

  message       String
  messageType   String    @default("text") @map("message_type") // text | image | file
  attachmentUrl String?   @map("attachment_url")

  isRead        Boolean   @default(false) @map("is_read")
  readAt        DateTime? @map("read_at")

  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  booking       Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender        Profile   @relation(fields: [senderId], references: [id])

  @@index([bookingId])
  @@map("booking_messages")
}

// ============================================
// BOOKING STATUS HISTORY
// ============================================
model BookingStatusHistory {
  id           String    @id @default(uuid())
  bookingId    String    @map("booking_id")
  changedBy    String?   @map("changed_by")

  oldStatus    String?   @map("old_status")
  newStatus    String    @map("new_status")
  changeReason String?   @map("change_reason")
  notes        String?

  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  booking      Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  changedByUser Profile? @relation(fields: [changedBy], references: [id])

  @@index([bookingId])
  @@map("booking_status_history")
}
